#!/bin/sh

topic() {
  echo "-----> $*"
}

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

if [ ! -s $ENV_DIR/INSTANA_AGENT_KEY -o ! -s $ENV_DIR/INSTANA_LOCATION -o ! -s $ENV_DIR/INSTANA_USERNAME -o ! -s $ENV_DIR/INSTANA_PASSWORD -o ! -s $ENV_DIR/INSTANA_TENANT -o ! -s $ENV_DIR/INSTANA_TENANT_UNIT ]; then
  echo "Must set INSTANA_AGENT_KEY, INSTANA_LOCATION, INSTANA_USERNAME, INSTANA_PASSWORD, INSTANA_TENANT and INSTANA_TENANT_UNIT"
  exit 1
else
  INSTANA_AGENT_KEY=$(cat $ENV_DIR/INSTANA_AGENT_KEY)
  INSTANA_LOCATION=$(cat $ENV_DIR/INSTANA_LOCATION)
  INSTANA_USERNAME=$(cat $ENV_DIR/INSTANA_USERNAME)
  INSTANA_PASSWORD=$(cat $ENV_DIR/INSTANA_PASSWORD)
  INSTANA_TENANT=$(cat $ENV_DIR/INSTANA_TENANT)
  INSTANA_TENANT_UNIT=$(cat $ENV_DIR/INSTANA_TENANT_UNIT)

  topic "Installing Instana agent"

  wget --save-cookies instana-cookies.txt --post-data "email=${INSTANA_USERNAME}&password=${INSTANA_PASSWORD}" https://${INSTANA_TENANT_UNIT}-${INSTANA_TENANT}.instana.io/auth/signIn
  wget --content-disposition --load-cookies instana-cookies.txt --post-data 'type=linux64' https://instana.io/ump/${INSTANA_TENANT}/${INSTANA_TENANT_UNIT}/agent/download -O agent.tar.gz

  tar xf agent.tar.gz -C $BUILD_DIR
fi | indent
