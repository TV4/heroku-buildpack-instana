#!/bin/sh

topic() {
  echo "-----> $*"
}

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
LP_DIR=`cd $(dirname $0); cd ..; pwd`


if [ ! -s $ENV_DIR/INSTANA_AGENT_KEY -o ! -s $ENV_DIR/INSTANA_LOCATION  ]; then
  echo "Must set INSTANA_AGENT_KEY and INSTANA_LOCATION"
  exit 1
else
  INSTANA_AGENT_KEY=$(cat $ENV_DIR/INSTANA_AGENT_KEY)
  INSTANA_LOCATION=$(cat $ENV_DIR/INSTANA_LOCATION)

  curl -O https://_:$INSTANA_AGENT_KEY@packages.instana.io/agent/deb/dists/generic/main/binary-amd64/instana-agent-static_20171205-0308_amd64.deb

  dpkg -x instana-agent-static_20171205-0308_amd64.deb $BUILD_DIR/instana

  # topic "Writing profile script"
  # mkdir -p $BUILD_DIR/.profile.d
  # cat <<EOF >$BUILD_DIR/.profile.d/000_apt.sh
  # export PATH="\$HOME/.apt/usr/bin:\$PATH"
  # export LD_LIBRARY_PATH="\$HOME/.apt/usr/lib/x86_64-linux-gnu:\$HOME/.apt/usr/lib/i386-linux-gnu:\$HOME/.apt/usr/lib:\$LD_LIBRARY_PATH"
  # export LIBRARY_PATH="\$HOME/.apt/usr/lib/x86_64-linux-gnu:\$HOME/.apt/usr/lib/i386-linux-gnu:\$HOME/.apt/usr/lib:\$LIBRARY_PATH"
  # export INCLUDE_PATH="\$HOME/.apt/usr/include:\$HOME/.apt/usr/include/x86_64-linux-gnu:\$INCLUDE_PATH"
  # export CPATH="\$INCLUDE_PATH"
  # export CPPPATH="\$INCLUDE_PATH"
  # export PKG_CONFIG_PATH="\$HOME/.apt/usr/lib/x86_64-linux-gnu/pkgconfig:\$HOME/.apt/usr/lib/i386-linux-gnu/pkgconfig:\$HOME/.apt/usr/lib/pkgconfig:\$PKG_CONFIG_PATH"
# EOF

  # #give environment to later buildpacks
  # export | grep -E -e ' (PATH|LD_LIBRARY_PATH|LIBRARY_PATH|INCLUDE_PATH|CPATH|CPPPATH|PKG_CONFIG_PATH)='  > "$LP_DIR/export"

  # topic "Rewrite package-config files"
  # find $BUILD_DIR/.apt -type f -ipath '*/pkgconfig/*.pc' | xargs --no-run-if-empty -n 1 sed -i -e 's!^prefix=\(.*\)$!prefix='"$BUILD_DIR"'/.apt\1!g'

fi | indent
